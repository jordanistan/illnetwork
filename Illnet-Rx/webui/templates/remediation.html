{% extends "layout.html" %}
{% block title %}Remediation Prescription - Illnet Rx{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <h2>Remediation Prescription (Rx)</h2>
  </div>
  <div class="card-content">
    <p>Generated from report for target: <strong>{{ target_host }}</strong></p>
    
    <div class="warning-box" style="padding: 1rem; border: 1px solid var(--danger-primary); background: rgba(248, 81, 73, 0.1); border-radius: 8px; margin-bottom: 1.5rem;">
      <h3 style="color: var(--danger-primary); margin-top: 0;">⚠️ DANGER: LIVE EXECUTION ⚠️</h3>
      <p>
        The script below was generated by an AI and will be executed on <strong>{{ target_host }}</strong>.
        It may contain errors or produce unintended and irreversible side effects.
      </p>
      <p>
        <strong>ALWAYS REVIEW AND UNDERSTAND ANY SCRIPT BEFORE EXECUTING IT.</strong>
        You are solely responsible for any changes this script makes.
      </p>
    </div>

    <div class="script-container">
      <h4>Generated Script:</h4>
      <pre id="script-content" class="terminal" style="height: auto; max-height: 40vh;"><code>{{ script }}</code></pre>
      <button id="copyBtn" class="btn">Copy Script</button>
    </div>

    <hr style="border-color: var(--border-color); margin: 2rem 0;">

    <div class="execution-container">
      <h3>Live Execution</h3>
      <p>To proceed, type "EXECUTE" into the box below and click the button.</p>
      <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
        <input type="text" id="confirm-input" placeholder="Type EXECUTE to confirm" style="flex-grow: 1; background: var(--bg-dark-primary); border: 1px solid var(--border-color); color: var(--text-primary); padding: 10px; border-radius: 6px;">
        <button id="executeBtn" class="btn btn-danger" disabled>Execute Remediation Script</button>
      </div>
      <h4>Execution Output:</h4>
      <pre id="log" class="terminal">Awaiting execution...</pre>
    </div>
  </div>
</div>

<script>
  const copyBtn = document.getElementById('copyBtn');
  const scriptContent = document.getElementById('script-content').textContent;
  const confirmInput = document.getElementById('confirm-input');
  const executeBtn = document.getElementById('executeBtn');
  const logEl = document.getElementById('log');

  // Copy button logic
  copyBtn.addEventListener('click', () => {
    navigator.clipboard.writeText(scriptContent.trim())
      .then(() => {
        copyBtn.textContent = 'Copied!';
        setTimeout(() => { copyBtn.textContent = 'Copy Script'; }, 2000);
      });
  });

  // Confirmation input logic
  confirmInput.addEventListener('input', () => {
    executeBtn.disabled = confirmInput.value !== 'EXECUTE';
  });

  function appendLog(line) {
    const sanitizedLine = line.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    logEl.innerHTML += (sanitizedLine + "\n");
    logEl.scrollTop = logEl.scrollHeight;
  }

  // Execute button logic with fetch for streaming POST
  executeBtn.addEventListener('click', async () => {
    executeBtn.disabled = true;
    confirmInput.disabled = true;
    logEl.innerHTML = 'Initializing remote execution...\n';

    try {
      const response = await fetch("{{ url_for('execute_remediation', target_host=target_host) }}", {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ script: scriptContent })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      while (true) {
        const { done, value } = await reader.read();
        if (done) {
          appendLog('=== Execution complete ===');
          executeBtn.textContent = 'Execution Finished';
          break;
        }
        
        buffer += decoder.decode(value, { stream: true });
        
        // Process buffer line by line
        let lines = buffer.split('\n');
        buffer = lines.pop(); // Keep the last partial line in the buffer

        for (const line of lines) {
          if (line.startsWith('data: ')) {
            appendLog(line.substring(6));
          } else if (line.startsWith('event: done')) {
            // The 'done' event is handled by the reader finishing
          }
        }
      }
    } catch (error) {
      appendLog(`[ERR] An error occurred with the execution stream: ${error}`);
      executeBtn.disabled = false;
      confirmInput.disabled = false;
    }
  });
</script>
{% endblock %}