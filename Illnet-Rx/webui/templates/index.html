{% extends "layout.html" %}
{% block title %}Diagnosis Engine - Illnet Rx{% endblock %}

{% block content %}
<div class="card">
  <div class="card-header">
    <h2>Diagnosis Engine</h2>
    <div style="display: flex; align-items: center; gap: 1rem;">
      <select id="scan-type-select" class="form-control">
        <option value="deep_scan">Deep Scan (Remote Target)</option>
        <option value="health_check">Host Health Check (Local)</option>
      </select>
      <button id="runBtn" class="btn btn-primary">Run Diagnosis</button>
    </div>
  </div>
  <div class="card-content">
    <h3>Vitals Monitor</h3>
    <pre id="log" class="terminal">Welcome to the Illnet Rx Diagnosis Engine. Select a scan type and click "Run Diagnosis" to begin.</pre>
  </div>
</div>

<style>
  .form-control {
    background: var(--bg-dark-primary);
    border: 1px solid var(--border-color);
    color: var(--text-primary);
    padding: 10px;
    border-radius: 6px;
    font-size: 1rem;
  }
</style>

<script>
  const runBtn = document.getElementById('runBtn');
  const logEl = document.getElementById('log');
  const scanTypeSelect = document.getElementById('scan-type-select');

  function append(line) {
    // Sanitize HTML content from the stream
    const sanitizedLine = line.replace(/</g, "&lt;").replace(/>/g, "&gt;");
    logEl.innerHTML += (sanitizedLine + "\n");
    logEl.scrollTop = logEl.scrollHeight;
  }

  function startScan() {
    runBtn.disabled = true;
    runBtn.textContent = 'Diagnosis in Progress...';
    logEl.innerHTML = 'Initializing diagnosis engine...\n';
    
    const scanType = scanTypeSelect.value;
    const url = new URL("{{ url_for('scan_stream') }}", window.location.origin);
    url.searchParams.append('scan_type', scanType);

    const sse = new EventSource(url);

    sse.onmessage = (e) => {
      append(e.data);
    };

    sse.addEventListener('done', () => {
      append('=== Diagnosis and analysis complete. You can view the full report in the Consultation History. ===');
      sse.close();
      runBtn.disabled = false;
      runBtn.textContent = 'Run New Diagnosis';
    });

    sse.onerror = () => {
      append('[ERR] An error occurred with the vitals monitor stream. Connection closed.');
      sse.close();
      runBtn.disabled = false;
      runBtn.textContent = 'Run New Diagnosis';
    };
  }

  runBtn.addEventListener('click', startScan);
</script>
{% endblock %}